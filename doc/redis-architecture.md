# Redis アーキテクチャ設計

## システム構成

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Browser A     │    │   Browser B     │    │   Browser C     │
│  (WebSocket)    │    │  (WebSocket)    │    │  (WebSocket)    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         │                       │                       │
         └───────────────────────┼───────────────────────┘
                                 │
              ┌─────────────────────────────────────┐
              │       Load Balancer               │
              └─────────────────────────────────────┘
                                 │
        ┌────────────────────────┼────────────────────────┐
        │                       │                       │
┌───────────────┐    ┌───────────────┐    ┌───────────────┐
│ WebSocket     │    │ WebSocket     │    │ WebSocket     │
│ Server 1      │    │ Server 2      │    │ Server 3      │
│ (Bun+Hono)    │    │ (Bun+Hono)    │    │ (Bun+Hono)    │
└───────────────┘    └───────────────┘    └───────────────┘
        │                       │                       │
        │                       │                       │
        └───────────────────────┼───────────────────────┘
                                 │
                ┌─────────────────────────────────────┐
                │         Redis Cluster             │
                │                                   │
                │  ┌─────────────────────────────┐  │
                │  │      Redis Pub/Sub         │  │
                │  │   (Channel Broadcasting)    │  │
                │  └─────────────────────────────┘  │
                │                                   │
                │  ┌─────────────────────────────┐  │
                │  │      Redis Storage         │  │
                │  │   (Key-Value Database)      │  │
                │  └─────────────────────────────┘  │
                └─────────────────────────────────────┘
```

## Redis 主要機能

### 1. データ永続化
- **投票データ**: `poll:{pollId}`
- **投票結果**: `poll:{pollId}:votes`
- **参加者リスト**: `poll:{pollId}:participants`
- **自動期限切れ**: `EXPIRE` コマンドによる TTL 管理

### 2. リアルタイム同期
- **Pub/Sub チャンネル**: `poll:{pollId}:updates`
- **システムイベント**: `poll:{pollId}:system`
- **水平スケーリング**: 複数 WebSocket サーバー間の自動同期

### 3. 重複投票防止
- **参加者セット**: `SADD poll:{pollId}:participants {userId}`
- **投票前チェック**: `SISMEMBER` による重複確認
- **アトミック操作**: `HINCRBY` による安全な投票カウント

## データフロー

### 投票実行フロー
```
1. Browser → WebSocket Server
   { type: "CAST_VOTE", data: { optionId: "opt-1" } }

2. WebSocket Server → Redis Storage
   SISMEMBER poll:123:participants user456  // 重複チェック
   HINCRBY poll:123:votes opt-1 1           // 投票カウント
   SADD poll:123:participants user456       // 参加者追加

3. WebSocket Server → Redis Pub/Sub
   PUBLISH poll:123:updates '{"type":"VOTE_CAST","optionId":"opt-1"}'

4. Redis Pub/Sub → All WebSocket Servers
   message: {"type":"VOTE_CAST","optionId":"opt-1","timestamp":"..."}

5. All WebSocket Servers → All Connected Browsers
   { type: "RESULTS_UPDATE", data: { results: [...] } }
```

### 投票結果取得フロー
```
1. Browser → WebSocket Server
   { type: "JOIN_POLL", data: { pollId: "poll-123" } }

2. WebSocket Server → Redis Storage
   GET poll:123                      // 投票情報取得
   HGETALL poll:123:votes           // 投票結果取得
   SCARD poll:123:participants      // 参加者数取得
   TTL poll:123                     // 残り時間取得

3. WebSocket Server → Browser
   { type: "POLL_UPDATE", data: { participantCount: 18, remainingTime: 180 } }
   { type: "RESULTS_UPDATE", data: { results: [...] } }
```

## 高可用性設計

### Redis Cluster 構成
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Redis Node 1  │    │   Redis Node 2  │    │   Redis Node 3  │
│   (Master)      │    │   (Master)      │    │   (Master)      │
│   Slot 0-5461   │    │   Slot 5462-    │    │   Slot 10923-   │
│                 │    │   10922         │    │   16383         │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         │                       │                       │
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Redis Node 4  │    │   Redis Node 5  │    │   Redis Node 6  │
│   (Replica)     │    │   (Replica)     │    │   (Replica)     │
│   Slot 0-5461   │    │   Slot 5462-    │    │   Slot 10923-   │
│                 │    │   10922         │    │   16383         │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### フェイルオーバー戦略
1. **自動フェイルオーバー**: Redis Cluster の組み込み機能
2. **WebSocket 再接続**: クライアント側自動再試行
3. **データ整合性**: Redis の強い整合性保証
4. **監視**: Redis Cluster の健全性監視

## パフォーマンス最適化

### 1. 接続管理
- **コネクションプール**: Redis 接続の効率的な管理
- **パイプライン**: 複数コマンドの一括実行
- **Keep-Alive**: 長時間接続の維持

### 2. メモリ最適化
- **データ圧縮**: JSON データの効率的な格納
- **TTL 管理**: 期限切れデータの自動削除
- **キー命名**: 階層的なキー構造による管理

### 3. ネットワーク最適化
- **バッチ処理**: 複数の Redis 操作をまとめて実行
- **Pub/Sub 最適化**: 効率的なチャンネル設計
- **レプリケーション**: 読み取り専用操作の負荷分散

## セキュリティ

### 1. 認証・認可
- **Redis AUTH**: パスワード認証
- **TLS 暗号化**: データ通信の暗号化
- **ネットワーク分離**: VPC 内での Redis 配置

### 2. アクセス制御
- **IP 制限**: 信頼できる IP からのみアクセス
- **ファイアウォール**: ポート制限とアクセス制御
- **Redis ACL**: ユーザーベースのアクセス制御

### 3. データ保護
- **バックアップ**: 定期的なデータバックアップ
- **暗号化**: 保存データの暗号化
- **監査ログ**: アクセスログの記録

## 監視・運用

### 1. メトリクス監視
- **Redis 統計**: INFO コマンドによる状態監視
- **接続数**: クライアント接続数の監視
- **メモリ使用量**: メモリ消費量の監視
- **レスポンス時間**: コマンド実行時間の監視

### 2. ログ監視
- **Redis ログ**: エラーログの監視
- **WebSocket ログ**: 接続状態の監視
- **アプリケーションログ**: 投票処理の監視

### 3. アラート設定
- **メモリ使用率**: 80% 以上でアラート
- **接続数**: 上限に近づいた場合のアラート
- **レスポンス時間**: 遅延発生時のアラート
- **エラー率**: エラー発生率の監視

## 災害復旧

### 1. バックアップ戦略
- **RDB スナップショット**: 定期的なデータスナップショット
- **AOF ログ**: 追記ログによる完全復旧
- **クロスリージョン**: 複数リージョンへのバックアップ

### 2. 復旧手順
1. **障害検知**: 自動監視による障害の早期発見
2. **フェイルオーバー**: 自動または手動でのフェイルオーバー
3. **データ復旧**: バックアップからのデータ復旧
4. **サービス復旧**: 段階的なサービス復旧

### 3. 事業継続計画
- **RTO**: 復旧時間目標 < 5分
- **RPO**: 復旧ポイント目標 < 1分
- **DR サイト**: 災害復旧サイトの準備
- **定期訓練**: 復旧手順の定期的な訓練

## スケーラビリティ

### 1. 水平スケーリング
- **WebSocket サーバー**: 需要に応じたサーバー追加
- **Redis Cluster**: クラスターノードの追加
- **ロードバランサー**: 負荷分散の最適化

### 2. 垂直スケーリング
- **CPU 増強**: 処理能力の向上
- **メモリ増強**: データキャッシュ容量の拡張
- **ネットワーク**: 帯域幅の増強

### 3. 自動スケーリング
- **CPU 使用率**: 70% 以上でスケールアウト
- **メモリ使用率**: 80% 以上でスケールアウト
- **接続数**: 上限に近づいた場合のスケールアウト
- **自動縮小**: 低負荷時の自動スケールイン