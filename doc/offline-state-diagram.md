# オフライン時の状態遷移図

## 投票参加者の状態遷移

```mermaid
graph TD
    A[投票画面（オンライン）] --> B[投票ボタンクリック]
    B --> C[投票送信中]
    C --> D[投票完了]
    D --> E[結果画面（オンライン）]
    
    A --> F[オフライン検知]
    F --> G[投票画面（オフライン）]
    G --> H[再接続試行]
    H --> I{再接続成功？}
    I -->|Yes| A
    I -->|No| H
    
    C --> J[送信中オフライン]
    J --> K[投票データ保存]
    K --> L[再接続待機]
    L --> M{再接続成功？}
    M -->|Yes| N[保存データ送信]
    M -->|No| L
    N --> O{送信成功？}
    O -->|Yes| D
    O -->|No| P[エラー表示]
    
    E --> Q[結果画面オフライン]
    Q --> R[最後のデータ表示]
    R --> S[再接続試行]
    S --> T{再接続成功？}
    T -->|Yes| E
    T -->|No| S
```

## 投票作成者の状態遷移

```mermaid
graph TD
    A[投票作成画面（オンライン）] --> B[投票作成・開始]
    B --> C[投票管理画面（オンライン）]
    
    A --> D[作成中オフライン]
    D --> E[入力データ保存]
    E --> F[投票開始無効化]
    F --> G[再接続試行]
    G --> H{再接続成功？}
    H -->|Yes| A
    H -->|No| G
    
    C --> I[管理画面オフライン]
    I --> J[最後のデータ表示]
    J --> K[管理機能制限]
    K --> L[再接続試行]
    L --> M{再接続成功？}
    M -->|Yes| C
    M -->|No| L
```

## 共通システム状態

```mermaid
graph TD
    A[WebSocket接続] --> B[通信正常]
    B --> C[Live状態]
    C --> D[データ送受信]
    D --> B
    
    B --> E[接続エラー検知]
    E --> F[Offline状態]
    F --> G[自動再接続開始]
    G --> H[再接続試行]
    H --> I{接続成功？}
    I -->|Yes| J[接続復旧]
    I -->|No| K[待機後再試行]
    K --> H
    J --> L[データ同期]
    L --> B
    
    F --> M[ユーザー操作制限]
    M --> N[オフライン表示]
    N --> O[保存データ管理]
```

## 状態別の動作

### Online状態（WebSocket + Redis接続成功）
- 全機能利用可能
- Redis Pub/Subによるリアルタイム更新
- 緑色インジケータ
- WebSocket経由でのRedis操作

### Offline状態（WebSocket切断）
- 機能制限（投票不可、結果表示のみ）
- 最後のデータ表示（LocalStorage）
- 赤色インジケータ
- Redis操作不可

### Reconnecting状態（WebSocket再接続中）
- 自動再接続中
- 黄色インジケータ（点滅）
- 操作一時無効
- LocalStorageデータ準備

### Error状態（Redis接続失敗）
- WebSocket接続成功でもRedis処理失敗
- エラーメッセージ表示
- 手動再試行可能
- 橙色インジケータ

### Sync状態（再接続後データ同期）
- Redis TTLによる投票時間確認
- Redis SCARDによる参加者数更新
- Redis HGETALLによる投票結果更新
- LocalStorageデータとRedisデータの整合性確認